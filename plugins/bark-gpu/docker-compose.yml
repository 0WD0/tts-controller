version: '3.8'

name: bark-gpu

services:
  bark-forward:
    container_name: tts-bark-gpu-forward
    image: tts-bark-gpu-forward
    build:
      context: ./forward
      dockerfile: Dockerfile
    environment:
      - TTS_TYPE=bark-gpu
      - TTS_SERVER_URL=http://bark-tts:5013
      - CONFIG_PATH=/config/bark-gpu/config.yml
      - LOG_PATH=/logs
    volumes:
      - ../../data/config:/config:ro
      - ../../data/logs/bark-gpu:/logs
      - ../../data/cache/bark-gpu:/cache
    networks:
      - tts-network
    depends_on:
      - bark-tts
    restart: unless-stopped
    develop:
      watch:
        - action: sync
          path: ./forward/app
          target: /app/app
          ignore:
            - "**/__pycache__"
            - "**/*.pyc"

  bark-tts:
    container_name: tts-bark-gpu
    image: tts-bark-gpu
    build:
      context: ./tts
      dockerfile: Dockerfile
    environment:
      - CONFIG_PATH=/config/bark-gpu/config.yml
      - LOG_PATH=/logs
      - CACHE_DIR=/cache
      - CUDA_VISIBLE_DEVICES=0
    volumes:
      - ../../data/config:/config:ro
      - ../../data/logs/bark-gpu:/logs
      - ../../data/cache/bark-gpu:/cache
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    networks:
      - tts-network
    restart: unless-stopped
    develop:
      watch:
        - action: sync
          path: ./tts/app
          target: /app/app
          ignore:
            - "**/__pycache__"
            - "**/*.pyc"

networks:
  tts-network:
    name: tts-network
    external: true
